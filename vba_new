Option Explicit

' ===============================
' Setup Dashboard
' ===============================
Sub SetupDashboard()
    Dim ws As Worksheet
    On Error Resume Next
    Set ws = ThisWorkbook.Sheets("Dashboard")
    If ws Is Nothing Then
        Set ws = ThisWorkbook.Sheets.Add(After:=Sheets(Sheets.Count))
        ws.Name = "Dashboard"
    Else
        ws.Cells.Clear
        Dim shp As Shape
        For Each shp In ws.Shapes
            shp.Delete
        Next shp
    End If
    On Error GoTo 0

    ' Title
    With ws.Range("B1:D1")
        .Merge
        .Value = "Dealer Activity Dashboard"
        .Font.Size = 14
        .Font.Bold = True
        .Font.Name = "Segoe UI"
        .Interior.Color = RGB(30, 90, 200)
        .Font.Color = vbWhite
        .HorizontalAlignment = xlCenter
    End With

    ' Dealer Filter
    ws.Range("B4").Value = "Dealer:"
    With ws.Range("C4")
        .ClearContents
        .Font.Name = "Segoe UI"
        .Font.Size = 11
        .Interior.Color = RGB(255, 255, 255)
        .Borders.LineStyle = xlContinuous
        .Borders.Weight = xlThin
        .ColumnWidth = 20
    End With

    ' Refresh Button
    Dim btn As Shape
    Set btn = ws.Shapes.AddFormControl(xlButtonControl, 350, 20, 140, 25)
    btn.TextFrame.Characters.Text = "Refresh Dashboard"
    btn.OnAction = "RefreshDashboard"

    ' Initial Load
    Call RefreshDashboard
End Sub

' ===============================
' Refresh Dashboard
' ===============================
Sub RefreshDashboard()
    Dim result As Variant
    result = RunPythonAndReturnArray()
    If IsEmpty(result) Then
        MsgBox "No data returned from Python", vbExclamation
        Exit Sub
    End If
    DrawDealerCharts result
End Sub

' ===============================
' Call Python and Get Array
' ===============================
Function RunPythonAndReturnArray() As Variant
    ' Use RunPython with a temp sheet to store the array
    Dim wb As Workbook: Set wb = ThisWorkbook
    Dim tempRange As Range
    Set tempRange = wb.Sheets("Dashboard").Range("Z1")

    ' Clear previous temp data
    tempRange.Resize(100, 5).Clear

    ' Python writes directly to range Z1 temporarily
    Application.Run "xlwings.RunPython", _
        "import dashboard_calc; " & _
        "import xlwings as xw; " & _
        "xw.Book.caller().sheets['Dashboard'].range('Z1').value = dashboard_calc.get_dealer_summary()"

    ' Load data back into VBA array
    RunPythonAndReturnArray = tempRange.CurrentRegion.Value

    ' Optional: Clear temp
    tempRange.Resize(100, 5).Clear
End Function

' ===============================
' Draw Charts
' ===============================
Sub DrawDealerCharts(data As Variant)
    Dim ws As Worksheet: Set ws = Sheets("Dashboard")
    Dim co As ChartObject
    Dim i As Long, n As Long
    Dim dealers() As String, quotes() As Double, trades() As Double

    n = UBound(data, 1)
    ReDim dealers(1 To n)
    ReDim quotes(1 To n)
    ReDim trades(1 To n)

    For i = 1 To n
        dealers(i) = data(i, 1)
        quotes(i) = data(i, 2)
        trades(i) = data(i, 3)
    Next i

    ' Remove old charts
    For Each co In ws.ChartObjects
        co.Delete
    Next co

    ' Quotes Chart
    Set co = ws.ChartObjects.Add(Left:=100, Top:=80, Width:=400, Height:=250)
    With co.Chart
        .ChartType = xlColumnClustered
        .SeriesCollection.NewSeries
        .SeriesCollection(1).Name = "Quotes"
        .SeriesCollection(1).XValues = dealers
        .SeriesCollection(1).Values = quotes
        .HasTitle = True
        .ChartTitle.Text = "Quotes per Dealer"
    End With

    ' Trades Chart
    Set co = ws.ChartObjects.Add(Left:=100, Top:=370, Width:=400, Height:=250)
    With co.Chart
        .ChartType = xlColumnClustered
        .SeriesCollection.NewSeries
        .SeriesCollection(1).Name = "Trades"
        .SeriesCollection(1).XValues = dealers
        .SeriesCollection(1).Values = trades
        .HasTitle = True
        .ChartTitle.Text = "Trades per Dealer"
    End With
End Sub
