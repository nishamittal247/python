Option Explicit

' ===============================
' Setup Dashboard
' ===============================
Sub SetupDashboard()
    Dim ws As Worksheet
    On Error Resume Next
    Set ws = ThisWorkbook.Sheets("Dashboard")
    If ws Is Nothing Then
        Set ws = ThisWorkbook.Sheets.Add(After:=Sheets(Sheets.Count))
        ws.Name = "Dashboard"
    Else
        ws.Cells.Clear
        Dim shp As Shape
        For Each shp In ws.Shapes
            shp.Delete
        Next shp
    End If
    On Error GoTo 0

    ' Title
    With ws.Range("B1:D1")
        .Merge
        .Value = "Dealer Activity Dashboard"
        .Font.Size = 14
        .Font.Bold = True
        .Font.Name = "Segoe UI"
        .Interior.Color = RGB(30, 90, 200)
        .Font.Color = vbWhite
        .HorizontalAlignment = xlCenter
    End With

    ' Dealer Filter Cell
    ws.Range("B4").Value = "Dealer:"
    With ws.Range("C4")
        .ClearContents
        .Font.Name = "Segoe UI"
        .Font.Size = 11
        .Interior.Color = RGB(255, 255, 255)
        .Borders.LineStyle = xlContinuous
        .Borders.Weight = xlThin
        .ColumnWidth = 20
    End With

    ' Create "Refresh" Button
    Dim btnRefresh As Shape
    Set btnRefresh = ws.Shapes.AddFormControl(xlButtonControl, 350, 20, 140, 25)
    btnRefresh.TextFrame.Characters.Text = "Refresh Dashboard"
    btnRefresh.OnAction = "RefreshDashboard"

    ' Initial Load
    Call RefreshDashboard
End Sub

' ===============================
' Refresh Dashboard
' ===============================
Sub RefreshDashboard()
    Dim data As Variant
    data = GetDataFromPython()

    If IsEmpty(data) Then
        MsgBox "No data available", vbExclamation
        Exit Sub
    End If

    DrawDealerCharts data
End Sub

' ===============================
' Call Python & Get Data
' ===============================
Function GetDataFromPython() As Variant
    Dim obj As Object
    Set obj = RunPythonReturn("import dashboard_calc; dashboard_calc.get_dealer_summary()")
    GetDataFromPython = obj
End Function

' ===============================
' Draw Charts
' ===============================
Sub DrawDealerCharts(data As Variant)
    Dim ws As Worksheet: Set ws = Sheets("Dashboard")
    Dim co As ChartObject
    Dim i As Long
    Dim dealers() As String, quotes() As Double, trades() As Double
    Dim n As Long
    
    ' Parse data
    n = UBound(data) - LBound(data) + 1
    ReDim dealers(1 To n)
    ReDim quotes(1 To n)
    ReDim trades(1 To n)
    
    For i = 1 To n
        dealers(i) = data(i - 1)(0)
        quotes(i) = data(i - 1)(1)
        trades(i) = data(i - 1)(2)
    Next i

    ' Remove old charts
    For Each co In ws.ChartObjects
        co.Delete
    Next co

    ' Draw Quotes Chart
    Set co = ws.ChartObjects.Add(Left:=100, Top:=80, Width:=400, Height:=250)
    co.Name = "QuotesChart"
    With co.Chart
        .ChartType = xlColumnClustered
        .SeriesCollection.NewSeries
        .SeriesCollection(1).Name = "Quotes"
        .SeriesCollection(1).XValues = dealers
        .SeriesCollection(1).Values = quotes
        .HasTitle = True
        .ChartTitle.Text = "Quotes per Dealer"
    End With

    ' Draw Trades Chart
    Set co = ws.ChartObjects.Add(Left:=100, Top:=370, Width:=400, Height:=250)
    co.Name = "TradesChart"
    With co.Chart
        .ChartType = xlColumnClustered
        .SeriesCollection.NewSeries
        .SeriesCollection(1).Name = "Trades"
        .SeriesCollection(1).XValues = dealers
        .SeriesCollection(1).Values = trades
        .HasTitle = True
        .ChartTitle.Text = "Trades per Dealer"
    End With
End Sub
